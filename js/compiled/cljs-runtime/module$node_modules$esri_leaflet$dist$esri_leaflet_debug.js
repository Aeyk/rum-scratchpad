shadow$provide.module$node_modules$esri_leaflet$dist$esri_leaflet_debug=function(global$jscomp$0,require,module,exports){(function(global,factory){"object"===typeof exports&&"undefined"!==typeof module?factory(exports,require("module$node_modules$leaflet$dist$leaflet_src")):"function"===typeof define&&define.amd?define(["exports","leaflet"],factory):(global=global||self,factory((global.L=global.L||{},global.L.esri={}),global.L))})(this,function(exports,leaflet){function serialize(params){var data=
"";params.f=params.f||"json";for(var key in params)if(params.hasOwnProperty(key)){var param=params[key],type=Object.prototype.toString.call(param);data.length&&(data+="\x26");param="[object Array]"===type?"[object Object]"===Object.prototype.toString.call(param[0])?JSON.stringify(param):param.join(","):"[object Object]"===type?JSON.stringify(param):"[object Date]"===type?param.valueOf():param;data+=encodeURIComponent(key)+"\x3d"+encodeURIComponent(param)}return data}function createRequest(callback,
context){var httpRequest=new window.XMLHttpRequest;httpRequest.onerror=function(e){httpRequest.onreadystatechange=leaflet.Util.falseFn;callback.call(context,{error:{code:500,message:"XMLHttpRequest error"}},null)};httpRequest.onreadystatechange=function(){if(4===httpRequest.readyState){try{var response=JSON.parse(httpRequest.responseText)}catch(e){response=null;var error={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}!error&&response.error&&
(error=response.error,response=null);httpRequest.onerror=leaflet.Util.falseFn;callback.call(context,error,response)}};httpRequest.ontimeout=function(){this.onerror()};return httpRequest}function xmlHttpPost(url,params,callback,context){callback=createRequest(callback,context);callback.open("POST",url);"undefined"!==typeof context&&null!==context&&"undefined"!==typeof context.options&&(callback.timeout=context.options.timeout);callback.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset\x3dUTF-8");
callback.send(serialize(params));return callback}function xmlHttpGet(url,params,callback,context){callback=createRequest(callback,context);callback.open("GET",url+"?"+serialize(params),!0);"undefined"!==typeof context&&null!==context&&"undefined"!==typeof context.options&&(callback.timeout=context.options.timeout,context.options.withCredentials&&(callback.withCredentials=!0));callback.send(null);return callback}function request$jscomp$0(url,params,callback,context){var paramString=serialize(params),
httpRequest=createRequest(callback,context),requestLength=(url+"?"+paramString).length;2E3>=requestLength&&Support.cors?httpRequest.open("GET",url+"?"+paramString):2E3<requestLength&&Support.cors&&(httpRequest.open("POST",url),httpRequest.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset\x3dUTF-8"));"undefined"!==typeof context&&null!==context&&"undefined"!==typeof context.options&&(httpRequest.timeout=context.options.timeout,context.options.withCredentials&&(httpRequest.withCredentials=
!0));if(2E3>=requestLength&&Support.cors)httpRequest.send(null);else if(2E3<requestLength&&Support.cors)httpRequest.send(paramString);else{if(2E3>=requestLength&&!Support.cors)return jsonp(url,params,callback,context);warn("a request to "+url+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html");return}return httpRequest}function jsonp(url,params,callback,context){window._EsriLeafletCallbacks=
window._EsriLeafletCallbacks||{};var callbackId="c"+callbacks;params.callback="window._EsriLeafletCallbacks."+callbackId;window._EsriLeafletCallbacks[callbackId]=function(response){if(!0!==window._EsriLeafletCallbacks[callbackId]){var responseType=Object.prototype.toString.call(response);if("[object Object]"!==responseType&&"[object Array]"!==responseType){var error={error:{code:500,message:"Expected array or object as JSONP response"}};response=null}!error&&response.error&&(error=response,response=
null);callback.call(context,error,response);window._EsriLeafletCallbacks[callbackId]=!0}};var script=leaflet.DomUtil.create("script",null,document.body);script.type="text/javascript";script.src=url+"?"+serialize(params);script.id=callbackId;script.onerror=function(error){error&&!0!==window._EsriLeafletCallbacks[callbackId]&&(callback.call(context,{error:{code:500,message:"An unknown error occurred"}}),window._EsriLeafletCallbacks[callbackId]=!0)};leaflet.DomUtil.addClass(script,"esri-leaflet-jsonp");
callbacks++;return{id:callbackId,url:script.src,abort:function(){window._EsriLeafletCallbacks._callback[callbackId]({code:0,message:"Request aborted."})}}}function warn(){console&&console.warn&&console.warn.apply(console,arguments)}function arcgisToGeoJSON$1(arcgis,idAttr){return arcgisToGeoJSON(arcgis,idAttr)}function extentToBounds(extent){if("NaN"!==extent.xmin&&"NaN"!==extent.ymin&&"NaN"!==extent.xmax&&"NaN"!==extent.ymax){var sw=leaflet.latLng(extent.ymin,extent.xmin);extent=leaflet.latLng(extent.ymax,
extent.xmax);return leaflet.latLngBounds(sw,extent)}return null}function boundsToExtent(bounds){bounds=leaflet.latLngBounds(bounds);return{xmin:bounds.getSouthWest().lng,ymin:bounds.getSouthWest().lat,xmax:bounds.getNorthEast().lng,ymax:bounds.getNorthEast().lat,spatialReference:{wkid:4326}}}function _findIdAttributeFromResponse(response){if(response.objectIdFieldName)var result=response.objectIdFieldName;else if(response.fields){for(var j=0;j<=response.fields.length-1;j++)if("esriFieldTypeOID"===
response.fields[j].type){result=response.fields[j].name;break}if(!result)for(j=0;j<=response.fields.length-1;j++)if(response.fields[j].name.match(knownFieldNames)){result=response.fields[j].name;break}}return result}function _findIdAttributeFromFeature(feature){for(var key in feature.attributes)if(key.match(knownFieldNames))return key}function responseToFeatureCollection(response,idAttribute){var features=response.features||response.results,count=features&&features.length;response=idAttribute?idAttribute:
_findIdAttributeFromResponse(response);idAttribute={type:"FeatureCollection",features:[]};if(count)for(count=features.length-1;0<=count;count--){var feature=arcgisToGeoJSON$1(features[count],response||_findIdAttributeFromFeature(features[count]));idAttribute.features.push(feature)}return idAttribute}function cleanUrl(url){url=leaflet.Util.trim(url);"/"!==url[url.length-1]&&(url+="/");return url}function getUrlParams(options){if(-1!==options.url.indexOf("?")){options.requestParams=options.requestParams||
{};var queryString=options.url.substring(options.url.indexOf("?")+1);options.url=options.url.split("?")[0];options.requestParams=JSON.parse('{"'+decodeURI(queryString).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')}options.url=cleanUrl(options.url.split("?")[0]);return options}function isArcgisOnline(url){return/^(?!.*utility\.arcgis\.com).*\.arcgis\.com.*FeatureServer/i.test(url)}function geojsonTypeToArcGIS(geoJsonType){switch(geoJsonType){case "Point":var arcgisGeometryType=
"esriGeometryPoint";break;case "MultiPoint":arcgisGeometryType="esriGeometryMultipoint";break;case "LineString":arcgisGeometryType="esriGeometryPolyline";break;case "MultiLineString":arcgisGeometryType="esriGeometryPolyline";break;case "Polygon":arcgisGeometryType="esriGeometryPolygon";break;case "MultiPolygon":arcgisGeometryType="esriGeometryPolygon"}return arcgisGeometryType}function calcAttributionWidth(map){return map.getSize().x-options$jscomp$0.attributionWidthOffset+"px"}function setEsriAttribution(map){if(map.attributionControl&&
!map.attributionControl._esriAttributionAdded){map.attributionControl.setPrefix('\x3ca href\x3d"http://leafletjs.com" title\x3d"A JS library for interactive maps"\x3eLeaflet\x3c/a\x3e | Powered by \x3ca href\x3d"https://www.esri.com"\x3eEsri\x3c/a\x3e');var hoverAttributionStyle=document.createElement("style");hoverAttributionStyle.type="text/css";hoverAttributionStyle.innerHTML=".esri-truncated-attribution:hover {white-space: normal;}";document.getElementsByTagName("head")[0].appendChild(hoverAttributionStyle);
leaflet.DomUtil.addClass(map.attributionControl._container,"esri-truncated-attribution:hover");hoverAttributionStyle=document.createElement("style");hoverAttributionStyle.type="text/css";hoverAttributionStyle.innerHTML=".esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: "+calcAttributionWidth(map)+";}";document.getElementsByTagName("head")[0].appendChild(hoverAttributionStyle);
leaflet.DomUtil.addClass(map.attributionControl._container,"esri-truncated-attribution");map.on("resize",function(e){map.attributionControl._container.style.maxWidth=calcAttributionWidth(e.target)});map.attributionControl._esriAttributionAdded=!0}}function _setGeometry(geometry){var params={geometry:null,geometryType:null};if(geometry instanceof leaflet.LatLngBounds)return params.geometry=boundsToExtent(geometry),params.geometryType="esriGeometryEnvelope",params;geometry.getLatLng&&(geometry=geometry.getLatLng());
geometry instanceof leaflet.LatLng&&(geometry={type:"Point",coordinates:[geometry.lng,geometry.lat]});geometry instanceof leaflet.GeoJSON&&(geometry=geometry.getLayers()[0].feature.geometry,params.geometry=geojsonToArcGIS(geometry,void 0),params.geometryType=geojsonTypeToArcGIS(geometry.type));geometry.toGeoJSON&&(geometry=geometry.toGeoJSON());"Feature"===geometry.type&&(geometry=geometry.geometry);if("Point"===geometry.type||"LineString"===geometry.type||"Polygon"===geometry.type||"MultiPolygon"===
geometry.type)return params.geometry=geojsonToArcGIS(geometry,void 0),params.geometryType=geojsonTypeToArcGIS(geometry.type),params;warn("invalid geometry passed to spatial query. Should be L.LatLng, L.LatLngBounds, L.Marker or a GeoJSON Point, Line, Polygon or MultiPolygon object")}function _getAttributionData(url,map){Support.cors&&request$jscomp$0(url,{},leaflet.Util.bind(function(error,attributions){if(!error){map._esriAttributions=[];for(error=0;error<attributions.contributors.length;error++)for(var contributor=
attributions.contributors[error],i=0;i<contributor.coverageAreas.length;i++){var coverageArea=contributor.coverageAreas[i],southWest=leaflet.latLng(coverageArea.bbox[0],coverageArea.bbox[1]),northEast=leaflet.latLng(coverageArea.bbox[2],coverageArea.bbox[3]);map._esriAttributions.push({attribution:contributor.attribution,score:coverageArea.score,bounds:leaflet.latLngBounds(southWest,northEast),minZoom:coverageArea.zoomMin,maxZoom:coverageArea.zoomMax})}map._esriAttributions.sort(function(a,b){return b.score-
a.score});_updateMapAttribution({target:map})}},this))}function _updateMapAttribution(evt){evt=evt.target;var oldAttributions=evt._esriAttributions;if(evt&&evt.attributionControl){var attributionElement=evt.attributionControl._container.querySelector(".esri-dynamic-attribution");if(attributionElement&&oldAttributions){var newAttributions="",bounds=evt.getBounds();bounds=leaflet.latLngBounds(bounds.getSouthWest().wrap(),bounds.getNorthEast().wrap());for(var zoom=evt.getZoom(),i=0;i<oldAttributions.length;i++){var attribution=
oldAttributions[i],text=attribution.attribution;!newAttributions.match(text)&&attribution.bounds.intersects(bounds)&&zoom>=attribution.minZoom&&zoom<=attribution.maxZoom&&(newAttributions+=", "+text)}newAttributions=newAttributions.substr(2);attributionElement.innerHTML=newAttributions;attributionElement.style.maxWidth=calcAttributionWidth(evt);evt.fire("attributionupdated",{attribution:newAttributions})}}}function query(options){return new Query(options)}function find(options){return new Find(options)}
function identifyFeatures(options){return new IdentifyFeatures(options)}function identifyImage(params){return new IdentifyImage(params)}function mapService(options){return new MapService(options)}function imageService(options){return new ImageService(options)}function featureLayerService(options){return new FeatureLayerService(options)}function BinarySearchIndex(values){this.values=[].concat(values||[])}var cors=window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest,pointerEvents=""===
document.documentElement.style.pointerEvents,Support={cors,pointerEvents},options$jscomp$0={attributionWidthOffset:55},callbacks=0,get=Support.cors?xmlHttpGet:jsonp;get.CORS=xmlHttpGet;get.JSONP=jsonp;var Request={request:request$jscomp$0,get,post:xmlHttpPost},arrayIntersectsArray=function(a,b){for(var i=0;i<a.length-1;i++)for(var j=0;j<b.length-1;j++){a:{var a1=a[i],a2=a[i+1],b1=b[j],b2=b[j+1],uaT=(b2[0]-b1[0])*(a1[1]-b1[1])-(b2[1]-b1[1])*(a1[0]-b1[0]);var JSCompiler_inline_result=(a2[0]-a1[0])*
(a1[1]-b1[1])-(a2[1]-a1[1])*(a1[0]-b1[0]);a1=(b2[1]-b1[1])*(a2[0]-a1[0])-(b2[0]-b1[0])*(a2[1]-a1[1]);if(0!==a1&&(uaT/=a1,JSCompiler_inline_result/=a1,0<=uaT&&1>=uaT&&0<=JSCompiler_inline_result&&1>=JSCompiler_inline_result)){JSCompiler_inline_result=!0;break a}JSCompiler_inline_result=!1}if(JSCompiler_inline_result)return!0}return!1},closeRing=function(coordinates){a:{var JSCompiler_inline_result=coordinates[0];for(var i=0;i<JSCompiler_inline_result.length;i++)if(JSCompiler_inline_result[i]!==coordinates[coordinates.length-
1][i]){JSCompiler_inline_result=!1;break a}JSCompiler_inline_result=!0}JSCompiler_inline_result||coordinates.push(coordinates[0]);return coordinates},ringIsClockwise=function(ringToTest){var total=0,i=0,rLength=ringToTest.length,pt1=ringToTest[i];for(i;i<rLength-1;i++){var pt2=ringToTest[i+1];total+=(pt2[0]-pt1[0])*(pt2[1]+pt1[1]);pt1=pt2}return 0<=total},shallowClone=function(obj){var target={},i;for(i in obj)obj.hasOwnProperty(i)&&(target[i]=obj[i]);return target},arcgisToGeoJSON=function arcgisToGeoJSON(arcgis,
idAttribute){var geojson={};if(arcgis.features){geojson.type="FeatureCollection";geojson.features=[];for(var i=0;i<arcgis.features.length;i++)geojson.features.push(arcgisToGeoJSON(arcgis.features[i],idAttribute))}"number"===typeof arcgis.x&&"number"===typeof arcgis.y&&(geojson.type="Point",geojson.coordinates=[arcgis.x,arcgis.y],"number"===typeof arcgis.z&&geojson.coordinates.push(arcgis.z));arcgis.points&&(geojson.type="MultiPoint",geojson.coordinates=arcgis.points.slice(0));arcgis.paths&&(1===arcgis.paths.length?
(geojson.type="LineString",geojson.coordinates=arcgis.paths[0].slice(0)):(geojson.type="MultiLineString",geojson.coordinates=arcgis.paths.slice(0)));if(arcgis.rings){var rings=arcgis.rings.slice(0);geojson=[];i=[];var outerRing,hole;for(hole=0;hole<rings.length;hole++){var ring=closeRing(rings[hole].slice(0));4>ring.length||(ringIsClockwise(ring)?(ring=[ring.slice().reverse()],geojson.push(ring)):i.push(ring.slice().reverse()))}for(ring=[];i.length;){hole=i.pop();var contained=!1;for(rings=geojson.length-
1;0<=rings;rings--){var outer=outerRing=geojson[rings][0],inner=hole;outerRing=arrayIntersectsArray(outer,inner);inner=inner[0];for(var contains=!1,i$jscomp$0=-1,l=outer.length,j=l-1;++i$jscomp$0<l;j=i$jscomp$0)(outer[i$jscomp$0][1]<=inner[1]&&inner[1]<outer[j][1]||outer[j][1]<=inner[1]&&inner[1]<outer[i$jscomp$0][1])&&inner[0]<(outer[j][0]-outer[i$jscomp$0][0])*(inner[1]-outer[i$jscomp$0][1])/(outer[j][1]-outer[i$jscomp$0][1])+outer[i$jscomp$0][0]&&(contains=!contains);outer=contains;if(!outerRing&&
outer){geojson[rings].push(hole);contained=!0;break}}contained||ring.push(hole)}for(;ring.length;){hole=ring.pop();i=!1;for(rings=geojson.length-1;0<=rings;rings--)if(outerRing=geojson[rings][0],arrayIntersectsArray(outerRing,hole)){geojson[rings].push(hole);i=!0;break}i||geojson.push([hole.reverse()])}geojson=1===geojson.length?{type:"Polygon",coordinates:geojson[0]}:{type:"MultiPolygon",coordinates:geojson}}"number"===typeof arcgis.xmin&&"number"===typeof arcgis.ymin&&"number"===typeof arcgis.xmax&&
"number"===typeof arcgis.ymax&&(geojson.type="Polygon",geojson.coordinates=[[[arcgis.xmax,arcgis.ymax],[arcgis.xmin,arcgis.ymax],[arcgis.xmin,arcgis.ymin],[arcgis.xmax,arcgis.ymin],[arcgis.xmax,arcgis.ymax]]]);if(arcgis.geometry||arcgis.attributes)if(geojson.type="Feature",geojson.geometry=arcgis.geometry?arcgisToGeoJSON(arcgis.geometry):null,geojson.properties=arcgis.attributes?shallowClone(arcgis.attributes):null,arcgis.attributes)try{i=geojson;a:{var attributes=arcgis.attributes;idAttribute=idAttribute?
[idAttribute,"OBJECTID","FID"]:["OBJECTID","FID"];for(rings=0;rings<idAttribute.length;rings++){var key=idAttribute[rings];if(key in attributes&&("string"===typeof attributes[key]||"number"===typeof attributes[key])){var JSCompiler_inline_result=attributes[key];break a}}throw Error("No valid id attribute found");}i.id=JSCompiler_inline_result}catch(err){}JSON.stringify(geojson.geometry)===JSON.stringify({})&&(geojson.geometry=null);arcgis.spatialReference&&arcgis.spatialReference.wkid&&4326!==arcgis.spatialReference.wkid&&
console.warn("Object converted in non-standard crs - "+JSON.stringify(arcgis.spatialReference));return geojson},orientRings=function(poly){var output=[];poly=poly.slice(0);var outerRing=closeRing(poly.shift().slice(0));if(4<=outerRing.length)for(ringIsClockwise(outerRing)||outerRing.reverse(),output.push(outerRing),outerRing=0;outerRing<poly.length;outerRing++){var hole=closeRing(poly[outerRing].slice(0));4<=hole.length&&(ringIsClockwise(hole)&&hole.reverse(),output.push(hole))}return output},geojsonToArcGIS=
function geojsonToArcGIS(geojson,idAttribute){idAttribute=idAttribute||"OBJECTID";var spatialReference={wkid:4326},result={};switch(geojson.type){case "Point":result.x=geojson.coordinates[0];result.y=geojson.coordinates[1];result.spatialReference=spatialReference;break;case "MultiPoint":result.points=geojson.coordinates.slice(0);result.spatialReference=spatialReference;break;case "LineString":result.paths=[geojson.coordinates.slice(0)];result.spatialReference=spatialReference;break;case "MultiLineString":result.paths=
geojson.coordinates.slice(0);result.spatialReference=spatialReference;break;case "Polygon":result.rings=orientRings(geojson.coordinates.slice(0));result.spatialReference=spatialReference;break;case "MultiPolygon":idAttribute=result;geojson=geojson.coordinates.slice(0);for(var output=[],i=0;i<geojson.length;i++)for(var polygon=orientRings(geojson[i]),x=polygon.length-1;0<=x;x--){var ring=polygon[x].slice(0);output.push(ring)}idAttribute.rings=output;result.spatialReference=spatialReference;break;case "Feature":geojson.geometry&&
(result.geometry=geojsonToArcGIS(geojson.geometry,idAttribute));result.attributes=geojson.properties?shallowClone(geojson.properties):{};geojson.id&&(result.attributes[idAttribute]=geojson.id);break;case "FeatureCollection":result=[];for(spatialReference=0;spatialReference<geojson.features.length;spatialReference++)result.push(geojsonToArcGIS(geojson.features[spatialReference],idAttribute));break;case "GeometryCollection":for(result=[],spatialReference=0;spatialReference<geojson.geometries.length;spatialReference++)result.push(geojsonToArcGIS(geojson.geometries[spatialReference],
idAttribute))}return result},knownFieldNames=/^(OBJECTID|FID|OID|ID)$/i,EsriUtil={warn,cleanUrl,getUrlParams,isArcgisOnline,geojsonTypeToArcGIS,responseToFeatureCollection,geojsonToArcGIS:function(geojson,idAttr){return geojsonToArcGIS(geojson,idAttr)},arcgisToGeoJSON:arcgisToGeoJSON$1,boundsToExtent,extentToBounds,calcAttributionWidth,setEsriAttribution,_setGeometry,_getAttributionData,_updateMapAttribution,_findIdAttributeFromFeature,_findIdAttributeFromResponse},Task=leaflet.Class.extend({options:{proxy:!1,
useCors:cors},generateSetter:function(param,context){return leaflet.Util.bind(function(value){this.params[param]=value;return this},context)},initialize:function(endpoint){endpoint.request&&endpoint.options?(this._service=endpoint,leaflet.Util.setOptions(this,endpoint.options)):(leaflet.Util.setOptions(this,endpoint),this.options.url=cleanUrl(endpoint.url));this.params=leaflet.Util.extend({},this.params||{});if(this.setters)for(var setter in this.setters)this[setter]=this.generateSetter(this.setters[setter],
this)},token:function(token){this._service?this._service.authenticate(token):this.params.token=token;return this},format:function(boolean){this.params.returnUnformattedValues=!boolean;return this},request:function(callback,context){this.options.requestParams&&leaflet.Util.extend(this.params,this.options.requestParams);return this._service?this._service.request(this.path,this.params,callback,context):this._request("request",this.path,this.params,callback,context)},_request:function(method,path,params,
callback,context){path=this.options.proxy?this.options.proxy+"?"+this.options.url+path:this.options.url+path;return"get"!==method&&"request"!==method||this.options.useCors?Request[method](path,params,callback,context):Request.get.JSONP(path,params,callback,context)}}),Query=Task.extend({setters:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",returnM:"returnM",transform:"datumTransformation",token:"token"},
path:"query",params:{returnGeometry:!0,where:"1\x3d1",outSR:4326,outFields:"*"},within:function(geometry){this._setGeometryParams(geometry);this.params.spatialRel="esriSpatialRelContains";return this},intersects:function(geometry){this._setGeometryParams(geometry);this.params.spatialRel="esriSpatialRelIntersects";return this},contains:function(geometry){this._setGeometryParams(geometry);this.params.spatialRel="esriSpatialRelWithin";return this},crosses:function(geometry){this._setGeometryParams(geometry);
this.params.spatialRel="esriSpatialRelCrosses";return this},touches:function(geometry){this._setGeometryParams(geometry);this.params.spatialRel="esriSpatialRelTouches";return this},overlaps:function(geometry){this._setGeometryParams(geometry);this.params.spatialRel="esriSpatialRelOverlaps";return this},bboxIntersects:function(geometry){this._setGeometryParams(geometry);this.params.spatialRel="esriSpatialRelEnvelopeIntersects";return this},indexIntersects:function(geometry){this._setGeometryParams(geometry);
this.params.spatialRel="esriSpatialRelIndexIntersects";return this},nearby:function(latlng,radius){latlng=leaflet.latLng(latlng);this.params.geometry=[latlng.lng,latlng.lat];this.params.geometryType="esriGeometryPoint";this.params.spatialRel="esriSpatialRelIntersects";this.params.units="esriSRUnit_Meter";this.params.distance=radius;this.params.inSr=4326;return this},where:function(string){this.params.where=string;return this},between:function(start,end){this.params.time=[start.valueOf(),end.valueOf()];
return this},simplify:function(map,factor){var mapWidth=Math.abs(map.getBounds().getWest()-map.getBounds().getEast());this.params.maxAllowableOffset=mapWidth/map.getSize().y*factor;return this},orderBy:function(fieldName,order){this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+",":"";this.params.orderByFields+=[fieldName,order||"ASC"].join(" ");return this},run:function(callback,context){this._cleanParams();return this.options.isModern||isArcgisOnline(this.options.url)&&
void 0===this.options.isModern?(this.params.f="geojson",this.request(function(error,response){this._trapSQLerrors(error);callback.call(context,error,response,response)},this)):this.request(function(error,response){this._trapSQLerrors(error);callback.call(context,error,response&&responseToFeatureCollection(response),response)},this)},count:function(callback,context){this._cleanParams();this.params.returnCountOnly=!0;return this.request(function(error,response){callback.call(this,error,response&&response.count,
response)},context)},ids:function(callback,context){this._cleanParams();this.params.returnIdsOnly=!0;return this.request(function(error,response){callback.call(this,error,response&&response.objectIds,response)},context)},bounds:function(callback,context){this._cleanParams();this.params.returnExtentOnly=!0;return this.request(function(error,response){response&&response.extent&&extentToBounds(response.extent)?callback.call(context,error,extentToBounds(response.extent),response):(error={message:"Invalid Bounds"},
callback.call(context,error,null,response))},context)},distinct:function(){this.params.returnGeometry=!1;this.params.returnDistinctValues=!0;return this},pixelSize:function(rawPoint){rawPoint=leaflet.point(rawPoint);this.params.pixelSize=[rawPoint.x,rawPoint.y];return this},layer:function(layer){this.path=layer+"/query";return this},_trapSQLerrors:function(error){error&&"400"===error.code&&warn("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},
_cleanParams:function(){delete this.params.returnIdsOnly;delete this.params.returnExtentOnly;delete this.params.returnCountOnly},_setGeometryParams:function(geometry){this.params.inSr=4326;geometry=_setGeometry(geometry);this.params.geometry=geometry.geometry;this.params.geometryType=geometry.geometryType}}),Find=Task.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",
precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs:function(id,where){this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"";this.params.layerDefs+=[id,where].join(":");return this},simplify:function(map,factor){var mapWidth=Math.abs(map.getBounds().getWest()-map.getBounds().getEast());this.params.maxAllowableOffset=
mapWidth/map.getSize().y*factor;return this},run:function(callback,context){return this.request(function(error,response){callback.call(context,error,response&&responseToFeatureCollection(response),response)},context)}}),Identify=Task.extend({path:"identify",between:function(start,end){this.params.time=[start.valueOf(),end.valueOf()];return this}}),IdentifyFeatures=Identify.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,
layers:"all",tolerance:3,returnGeometry:!0},on:function(map){var extent=boundsToExtent(map.getBounds());map=map.getSize();this.params.imageDisplay=[map.x,map.y,96];this.params.mapExtent=[extent.xmin,extent.ymin,extent.xmax,extent.ymax];return this},at:function(geometry){2===geometry.length&&(geometry=leaflet.latLng(geometry));this._setGeometryParams(geometry);return this},layerDef:function(id,where){this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"";this.params.layerDefs+=[id,
where].join(":");return this},simplify:function(map,factor){var mapWidth=Math.abs(map.getBounds().getWest()-map.getBounds().getEast());this.params.maxAllowableOffset=mapWidth/map.getSize().y*factor;return this},run:function(callback,context){return this.request(function(error,response){if(error)callback.call(context,error,void 0,response);else{error=responseToFeatureCollection(response);response.results=response.results.reverse();for(var i=0;i<error.features.length;i++)error.features[i].layerId=response.results[i].layerId;
callback.call(context,void 0,error,response)}})},_setGeometryParams:function(geometry){geometry=_setGeometry(geometry);this.params.geometry=geometry.geometry;this.params.geometryType=geometry.geometryType}}),IdentifyImage=Identify.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:!1},at:function(latlng){latlng=leaflet.latLng(latlng);this.params.geometry=
JSON.stringify({x:latlng.lng,y:latlng.lat,spatialReference:{wkid:4326}});this.params.geometryType="esriGeometryPoint";return this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(callback,context){return this.request(function(error,response){callback.call(context,error,response&&this._responseToGeoJSON(response),response)},this)},_responseToGeoJSON:function(response){var location=
response.location,catalogItems=response.catalogItems,catalogItemVisibilities=response.catalogItemVisibilities;location={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[location.x,location.y]},crs:{type:"EPSG",properties:{code:location.spatialReference.wkid}},properties:{OBJECTID:response.objectId,name:response.name,value:response.value},id:response.objectId}};response.properties&&response.properties.Values&&(location.pixel.properties.values=response.properties.Values);if(catalogItems&&catalogItems.features&&
(location.catalogItems=responseToFeatureCollection(catalogItems),catalogItemVisibilities&&catalogItemVisibilities.length===location.catalogItems.features.length))for(response=catalogItemVisibilities.length-1;0<=response;response--)location.catalogItems.features[response].properties.catalogItemVisibility=catalogItemVisibilities[response];return location}}),Service=leaflet.Evented.extend({options:{proxy:!1,useCors:cors,timeout:0},initialize:function(options){options=options||{};this._requestQueue=[];
this._authenticating=!1;leaflet.Util.setOptions(this,options);this.options.url=cleanUrl(this.options.url)},get:function(path,params,callback,context){return this._request("get",path,params,callback,context)},post:function(path,params,callback,context){return this._request("post",path,params,callback,context)},request:function(path,params,callback,context){return this._request("request",path,params,callback,context)},metadata:function(callback,context){return this._request("get","",{},callback,context)},
authenticate:function(token){this._authenticating=!1;this.options.token=token;this._runQueue();return this},getTimeout:function(){return this.options.timeout},setTimeout:function(timeout){this.options.timeout=timeout},_request:function(method,path,params,callback,context){this.fire("requeststart",{url:this.options.url+path,params,method},!0);var wrappedCallback=this._createServiceCallback(method,path,params,callback,context);this.options.token&&(params.token=this.options.token);this.options.requestParams&&
leaflet.Util.extend(params,this.options.requestParams);if(this._authenticating)this._requestQueue.push([method,path,params,callback,context]);else return path=this.options.proxy?this.options.proxy+"?"+this.options.url+path:this.options.url+path,"get"!==method&&"request"!==method||this.options.useCors?Request[method](path,params,wrappedCallback,context):Request.get.JSONP(path,params,wrappedCallback,context)},_createServiceCallback:function(method,path,params,callback,context){return leaflet.Util.bind(function(error,
response){!error||499!==error.code&&498!==error.code||(this._authenticating=!0,this._requestQueue.push([method,path,params,callback,context]),this.fire("authenticationrequired",{authenticate:leaflet.Util.bind(this.authenticate,this)},!0),error.authenticate=leaflet.Util.bind(this.authenticate,this));callback.call(context,error,response);error?this.fire("requesterror",{url:this.options.url+path,params,message:error.message,code:error.code,method},!0):this.fire("requestsuccess",{url:this.options.url+
path,params,response,method},!0);this.fire("requestend",{url:this.options.url+path,params,method},!0)},this)},_runQueue:function(){for(var i=this._requestQueue.length-1;0<=i;i--){var request=this._requestQueue[i];this[request.shift()].apply(this,request)}this._requestQueue=[]}}),MapService=Service.extend({identify:function(){return identifyFeatures(this)},find:function(){return find(this)},query:function(){return query(this)}}),ImageService=Service.extend({query:function(){return query(this)},identify:function(){return identifyImage(this)}}),
FeatureLayerService=Service.extend({options:{idAttribute:"OBJECTID"},query:function(){return query(this)},addFeature:function(feature,callback,context){this.addFeatures(feature,callback,context)},addFeatures:function(features,callback,context){for(var featuresArray=features.features?features.features:[features],i=featuresArray.length-1;0<=i;i--)delete featuresArray[i].id;features=geojsonToArcGIS(features,void 0);features=1<featuresArray.length?features:[features];return this.post("addFeatures",{features},
function(error,response){var result=response&&response.addResults?1<response.addResults.length?response.addResults:response.addResults[0]:void 0;callback&&callback.call(context,error||response.addResults[0].error,result)},context)},updateFeature:function(feature,callback,context){this.updateFeatures(feature,callback,context)},updateFeatures:function(features,callback,context){var featuresArray=features.features?features.features:[features];features=geojsonToArcGIS(features,this.options.idAttribute);
features=1<featuresArray.length?features:[features];return this.post("updateFeatures",{features},function(error,response){var result=response&&response.updateResults?1<response.updateResults.length?response.updateResults:response.updateResults[0]:void 0;callback&&callback.call(context,error||response.updateResults[0].error,result)},context)},deleteFeature:function(id,callback,context){this.deleteFeatures(id,callback,context)},deleteFeatures:function(ids,callback,context){return this.post("deleteFeatures",
{objectIds:ids},function(error,response){var result=response&&response.deleteResults?1<response.deleteResults.length?response.deleteResults:response.deleteResults[0]:void 0;callback&&callback.call(context,error||response.deleteResults[0].error,result)},context)}}),tileProtocol="https:"!==window.location.protocol?"http:":"https:",BasemapLayer=leaflet.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map"}},Topographic:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map"}},Oceans:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap"}},OceansLabels:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},NationalGeographic:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",
options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"National Geographic, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, increment P Corp."}},DarkGray:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, \x26copy; OpenStreetMap contributors"}},DarkGrayLabels:{urlTemplate:tileProtocol+
"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},Gray:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, \x26copy; OpenStreetMap contributors"}},
GrayLabels:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},Imagery:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community",
attributionUrl:"https://static.arcgis.com/attribution/World_Imagery"}},ImageryLabels:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},ImageryTransportation:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,
maxZoom:19,subdomains:["server","services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},ShadedRelief:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS"}},ShadedReliefLabels:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,
maxZoom:12,subdomains:["server","services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},Terrain:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS, NOAA"}},TerrainLabels:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server",
"services"],pane:pointerEvents?"esri-labels":"tilePane",attribution:""}},USATopo:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:15,subdomains:["server","services"],attribution:"USGS, National Geographic Society, i-cubed"}},ImageryClarity:{urlTemplate:tileProtocol+"//clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"}},
Physical:{urlTemplate:tileProtocol+"//{s}.arcgisonline.com/arcgis/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:8,subdomains:["server","services"],attribution:"U.S. National Park Service"}},ImageryFirefly:{urlTemplate:tileProtocol+"//fly.maptiles.arcgis.com/arcgis/rest/services/World_Imagery_Firefly/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community",
attributionUrl:"https://static.arcgis.com/attribution/World_Imagery"}}}},initialize:function(key,options){if("object"!==typeof key||!key.urlTemplate||!key.options)if("string"===typeof key&&BasemapLayer.TILES[key])key=BasemapLayer.TILES[key];else throw Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Physical", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ImageryClarity", "ImageryFirefly", ShadedRelief", "ShadedReliefLabels", "Terrain", "TerrainLabels" or "USATopo"');
options=leaflet.Util.extend(key.options,options);leaflet.Util.setOptions(this,options);this.options.token&&-1===key.urlTemplate.indexOf("token\x3d")&&(key.urlTemplate+="?token\x3d"+this.options.token);this.options.proxy&&(key.urlTemplate=this.options.proxy+"?"+key.urlTemplate);leaflet.TileLayer.prototype.initialize.call(this,key.urlTemplate,options)},onAdd:function(map){setEsriAttribution(map);"esri-labels"===this.options.pane&&this._initPane();this.options.attributionUrl&&_getAttributionData((this.options.proxy?
this.options.proxy+"?":"")+this.options.attributionUrl,map);map.on("moveend",_updateMapAttribution);leaflet.TileLayer.prototype.onAdd.call(this,map)},onRemove:function(map){map.off("moveend",_updateMapAttribution);leaflet.TileLayer.prototype.onRemove.call(this,map)},_initPane:function(){if(!this._map.getPane(this.options.pane)){var pane=this._map.createPane(this.options.pane);pane.style.pointerEvents="none";pane.style.zIndex=500}},getAttribution:function(){if(this.options.attribution)var attribution=
'\x3cspan class\x3d"esri-dynamic-attribution"\x3e'+this.options.attribution+"\x3c/span\x3e";return attribution}}),TiledMapLayer=leaflet.TileLayer.extend({options:{zoomOffsetAllowance:.1,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg\x3d\x3d"},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,
2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize:function(options){options=leaflet.Util.setOptions(this,options);
options=getUrlParams(options);this.tileUrl=(options.proxy?options.proxy+"?":"")+options.url+"tile/{z}/{y}/{x}"+(options.requestParams&&0<Object.keys(options.requestParams).length?leaflet.Util.getParamString(options.requestParams):"");-1!==options.url.indexOf("{s}")&&options.subdomains&&(options.url=options.url.replace("{s}",options.subdomains[0]));this.service=mapService(options);this.service.addEventParent(this);(new RegExp(/tiles.arcgis(online)?\.com/g)).test(options.url)&&(this.tileUrl=this.tileUrl.replace("://tiles",
"://tiles{s}"),options.subdomains=["1","2","3","4"]);this.options.token&&(this.tileUrl+="?token\x3d"+this.options.token);leaflet.TileLayer.prototype.initialize.call(this,this.tileUrl,options)},getTileUrl:function(tilePoint){var zoom=this._getZoomForUrl();return leaflet.Util.template(this.tileUrl,leaflet.Util.extend({s:this._getSubdomain(tilePoint),x:tilePoint.x,y:tilePoint.y,z:this._lodMap&&this._lodMap[zoom]?this._lodMap[zoom]:zoom},this.options))},createTile:function(coords,done){var tile=document.createElement("img");
leaflet.DomEvent.on(tile,"load",leaflet.Util.bind(this._tileOnLoad,this,done,tile));leaflet.DomEvent.on(tile,"error",leaflet.Util.bind(this._tileOnError,this,done,tile));this.options.crossOrigin&&(tile.crossOrigin="");tile.alt="";if(!this._lodMap||this._lodMap&&this._lodMap[this._getZoomForUrl()])tile.src=this.getTileUrl(coords);else this.once("lodmap",function(){tile.src=this.getTileUrl(coords)},this);return tile},onAdd:function(map){setEsriAttribution(map);this._lodMap||this.metadata(function(error,
metadata){if(!error&&metadata.spatialReference)if(error=metadata.spatialReference.latestWkid||metadata.spatialReference.wkid,!this.options.attribution&&map.attributionControl&&metadata.copyrightText&&(this.options.attribution=metadata.copyrightText,map.attributionControl.addAttribution(this.getAttribution())),map.options.crs!==leaflet.CRS.EPSG3857||102100!==error&&3857!==error)map.options.crs&&map.options.crs.code&&-1<map.options.crs.code.indexOf(error)||warn("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html");
else{this._lodMap={};metadata=metadata.tileInfo.lods;error=TiledMapLayer.MercatorZoomLevels;for(var i=0;i<metadata.length;i++){var arcgisLOD=metadata[i],ci;for(ci in error)if(this._withinPercentage(arcgisLOD.resolution,error[ci],this.options.zoomOffsetAllowance)){this._lodMap[ci]=arcgisLOD.level;break}}this.fire("lodmap")}},this);leaflet.TileLayer.prototype.onAdd.call(this,map)},metadata:function(callback,context){this.service.metadata(callback,context);return this},identify:function(){return this.service.identify()},
find:function(){return this.service.find()},query:function(){return this.service.query()},authenticate:function(token){var tokenQs="?token\x3d"+token;this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,tokenQs):this.tileUrl+tokenQs;this.options.token=token;this.service.authenticate(token);return this},_withinPercentage:function(a,b,percentage){return Math.abs(a/b-1)<percentage}}),Overlay=leaflet.ImageOverlay.extend({onAdd:function(map){this._topLeft=map.getPixelBounds().min;leaflet.ImageOverlay.prototype.onAdd.call(this,
map)},_reset:function(){this._map.options.crs===leaflet.CRS.EPSG3857?leaflet.ImageOverlay.prototype._reset.call(this):leaflet.DomUtil.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}});cors=leaflet.Layer.extend({options:{opacity:1,position:"front",f:"image",useCors:cors,attribution:null,interactive:!1,alt:""},onAdd:function(map){setEsriAttribution(map);this.options.zIndex&&(this.options.position=null);this._update=leaflet.Util.throttle(this._update,this.options.updateInterval,
this);map.on("moveend",this._update,this);this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?map.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null);this._update();this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this));this.metadata(function(err,metadata){!err&&!this.options.attribution&&map.attributionControl&&metadata.copyrightText&&(this.options.attribution=
metadata.copyrightText,map.attributionControl.addAttribution(this.getAttribution()))},this)},onRemove:function(map){this._currentImage&&this._map.removeLayer(this._currentImage);this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this));this._map.off("moveend",this._update,this)},bindPopup:function(fn,popupOptions){this._lastClick=this._shouldRenderPopup=!1;this._popup=leaflet.popup(popupOptions);this._popupFunction=fn;this._map&&(this._map.on("click",
this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this));return this},unbindPopup:function(){this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this));this._popup=!1;return this},bringToFront:function(){this.options.position="front";this._currentImage&&(this._currentImage.bringToFront(),this._setAutoZIndex(Math.max));return this},bringToBack:function(){this.options.position="back";this._currentImage&&
(this._currentImage.bringToBack(),this._setAutoZIndex(Math.min));return this},setZIndex:function(value){this.options.zIndex=value;this._currentImage&&this._currentImage.setZIndex(value);return this},_setAutoZIndex:function(compare){if(this._currentImage){for(var layers=this._currentImage.getPane().children,edgeZIndex=-compare(-Infinity,Infinity),i=0,len=layers.length,zIndex;i<len;i++)zIndex=layers[i].style.zIndex,layers[i]!==this._currentImage._image&&zIndex&&(edgeZIndex=compare(edgeZIndex,+zIndex));
isFinite(edgeZIndex)&&(this.options.zIndex=edgeZIndex+compare(-1,1),this.setZIndex(this.options.zIndex))}},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(opacity){this.options.opacity=opacity;this._currentImage&&this._currentImage.setOpacity(opacity);return this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(from,to){this.options.from=from;this.options.to=to;this._update();
return this},metadata:function(callback,context){this.service.metadata(callback,context);return this},authenticate:function(token){this.service.authenticate(token);return this},redraw:function(){this._update()},_renderImage:function(url,bounds,contentType){if(this._map&&(contentType&&(url="data:"+contentType+";base64,"+url),url)){var image=(new Overlay(url,bounds,{opacity:0,crossOrigin:this.options.withCredentials?"use-credentials":this.options.useCors,alt:this.options.alt,pane:this.options.pane||
this.getPane(),interactive:this.options.interactive})).addTo(this._map),onOverlayLoad=function(e){image.off("error",onOverlayLoad,this);if(this._map){e=e.target;var oldImage=this._currentImage;e._bounds.equals(bounds)&&e._bounds.equals(this._map.getBounds())?(this._currentImage=e,"front"===this.options.position?this.bringToFront():"back"===this.options.position&&this.bringToBack(),this.options.zIndex&&this.setZIndex(this.options.zIndex),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):
this._currentImage._map.removeLayer(this._currentImage),oldImage&&this._map&&this._map.removeLayer(oldImage),oldImage&&oldImage._map&&oldImage._map.removeLayer(oldImage)):this._map.removeLayer(e)}this.fire("load",{bounds})};image.once("error",function(){this._map.removeLayer(image);this.fire("error");image.off("load",onOverlayLoad,this)},this);image.once("load",onOverlayLoad,this)}},_update:function(){if(this._map){var zoom=this._map.getZoom(),bounds=this._map.getBounds();this._animatingZoom||this._map._panTransition&&
this._map._panTransition._inProgress||(zoom>this.options.maxZoom||zoom<this.options.minZoom?this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null):(zoom=this._buildExportParams(),leaflet.Util.extend(zoom,this.options.requestParams),zoom?(this._requestExport(zoom,bounds),this.fire("loading",{bounds})):this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null)))}},_renderPopup:function(latlng,error,results,response){latlng=
leaflet.latLng(latlng);this._shouldRenderPopup&&this._lastClick.equals(latlng)&&(error=this._popupFunction(error,results,response))&&this._popup.setLatLng(latlng).setContent(error).openOn(this._map)},_resetPopupState:function(e){this._shouldRenderPopup=!1;this._lastClick=e.latlng},_calculateBbox:function(){var pixelBounds=this._map.getPixelBounds(),sw=this._map.unproject(pixelBounds.getBottomLeft());pixelBounds=this._map.unproject(pixelBounds.getTopRight());pixelBounds=this._map.options.crs.project(pixelBounds);
sw=this._map.options.crs.project(sw);sw=leaflet.bounds(pixelBounds,sw);return[sw.getBottomLeft().x,sw.getBottomLeft().y,sw.getTopRight().x,sw.getTopRight().y].join()},_calculateImageSize:function(){var bounds=this._map.getPixelBounds(),size=this._map.getSize(),sw=this._map.unproject(bounds.getBottomLeft());bounds=this._map.unproject(bounds.getTopRight());bounds=this._map.latLngToLayerPoint(bounds).y;sw=this._map.latLngToLayerPoint(sw).y;if(0<bounds||sw<size.y)size.y=sw-bounds;return size.x+","+size.y}});
var ImageMapLayer=cors.extend({options:{updateInterval:150,format:"jpgpng",transparent:!0,f:"image"},query:function(){return this.service.query()},identify:function(){return this.service.identify()},initialize:function(options){options=getUrlParams(options);this.service=imageService(options);this.service.addEventParent(this);leaflet.Util.setOptions(this,options)},setPixelType:function(pixelType){this.options.pixelType=pixelType;this._update();return this},getPixelType:function(){return this.options.pixelType},
setBandIds:function(bandIds){leaflet.Util.isArray(bandIds)?this.options.bandIds=bandIds.join(","):this.options.bandIds=bandIds.toString();this._update();return this},getBandIds:function(){return this.options.bandIds},setNoData:function(noData,noDataInterpretation){leaflet.Util.isArray(noData)?this.options.noData=noData.join(","):this.options.noData=noData.toString();noDataInterpretation&&(this.options.noDataInterpretation=noDataInterpretation);this._update();return this},getNoData:function(){return this.options.noData},
getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(renderingRule){this.options.renderingRule=renderingRule;this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(mosaicRule){this.options.mosaicRule=mosaicRule;this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(e){var callback=leaflet.Util.bind(function(error,results,response){error||setTimeout(leaflet.Util.bind(function(){this._renderPopup(e.latlng,
error,results,response)},this),300)},this),identifyRequest=this.identify().at(e.latlng);this.options.mosaicRule&&identifyRequest.setMosaicRule(this.options.mosaicRule);identifyRequest.run(callback);this._shouldRenderPopup=!0;this._lastClick=e.latlng},_buildExportParams:function(){var sr=parseInt(this._map.options.crs.code.split(":")[1],10);sr={bbox:this._calculateBbox(),size:this._calculateImageSize(),format:this.options.format,transparent:this.options.transparent,bboxSR:sr,imageSR:sr};this.options.from&&
this.options.to&&(sr.time=this.options.from.valueOf()+","+this.options.to.valueOf());this.options.pixelType&&(sr.pixelType=this.options.pixelType);this.options.interpolation&&(sr.interpolation=this.options.interpolation);this.options.compressionQuality&&(sr.compressionQuality=this.options.compressionQuality);this.options.bandIds&&(sr.bandIds=this.options.bandIds);if(0===this.options.noData||this.options.noData)sr.noData=this.options.noData;this.options.noDataInterpretation&&(sr.noDataInterpretation=
this.options.noDataInterpretation);this.service.options.token&&(sr.token=this.service.options.token);this.options.renderingRule&&(sr.renderingRule=JSON.stringify(this.options.renderingRule));this.options.mosaicRule&&(sr.mosaicRule=JSON.stringify(this.options.mosaicRule));return sr},_requestExport:function(params,bounds){"json"===this.options.f?this.service.request("exportImage",params,function(error,response){error||(this.options.token&&(response.href+="?token\x3d"+this.options.token),this.options.proxy&&
(response.href=this.options.proxy+"?"+response.href),this._renderImage(response.href,bounds))},this):(params.f="image",params=this.options.url+"exportImage"+leaflet.Util.getParamString(params),this.options.proxy&&(params=this.options.proxy+"?"+params),this._renderImage(params,bounds))}}),DynamicMapLayer=cors.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png32",transparent:!0,f:"json"},initialize:function(options){options=getUrlParams(options);this.service=mapService(options);
this.service.addEventParent(this);leaflet.Util.setOptions(this,options)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(dynamicLayers){this.options.dynamicLayers=dynamicLayers;this._update();return this},getLayers:function(){return this.options.layers},setLayers:function(layers){this.options.layers=layers;this._update();return this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(layerDefs){this.options.layerDefs=layerDefs;this._update();
return this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(timeOptions){this.options.timeOptions=timeOptions;this._update();return this},query:function(){return this.service.query()},identify:function(){return this.service.identify()},find:function(){return this.service.find()},_getPopupData:function(e){var callback=leaflet.Util.bind(function(error,featureCollection,response){error||setTimeout(leaflet.Util.bind(function(){this._renderPopup(e.latlng,error,featureCollection,
response)},this),300)},this);var identifyRequest=this.options.popup?this.options.popup.on(this._map).at(e.latlng):this.identify().on(this._map).at(e.latlng);identifyRequest.params.maxAllowableOffset?!0:identifyRequest.simplify(this._map,.5);this.options.popup&&this.options.popup.params&&this.options.popup.params.layers||(this.options.layers?identifyRequest.layers("visible:"+this.options.layers.join(",")):identifyRequest.layers("visible"));if(this.options.layerDefs&&"string"!==typeof this.options.layerDefs&&
!identifyRequest.params.layerDefs)for(var id in this.options.layerDefs)this.options.layerDefs.hasOwnProperty(id)&&identifyRequest.layerDef(id,this.options.layerDefs[id]);identifyRequest.run(callback);this._shouldRenderPopup=!0;this._lastClick=e.latlng},_buildExportParams:function(){var sr=parseInt(this._map.options.crs.code.split(":")[1],10);sr={bbox:this._calculateBbox(),size:this._calculateImageSize(),dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:sr,imageSR:sr};this.options.dynamicLayers&&
(sr.dynamicLayers=this.options.dynamicLayers);if(this.options.layers){if(0===this.options.layers.length)return;sr.layers="show:"+this.options.layers.join(",")}this.options.layerDefs&&(sr.layerDefs="string"===typeof this.options.layerDefs?this.options.layerDefs:JSON.stringify(this.options.layerDefs));this.options.timeOptions&&(sr.timeOptions=JSON.stringify(this.options.timeOptions));this.options.from&&this.options.to&&(sr.time=this.options.from.valueOf()+","+this.options.to.valueOf());this.service.options.token&&
(sr.token=this.service.options.token);this.options.proxy&&(sr.proxy=this.options.proxy);this.options.disableCache&&(sr._ts=Date.now());return sr},_requestExport:function(params,bounds){"json"===this.options.f?this.service.request("export",params,function(error,response){error||(this.options.token&&response.href&&(response.href+="?token\x3d"+this.options.token),this.options.proxy&&response.href&&(response.href=this.options.proxy+"?"+response.href),response.href?this._renderImage(response.href,bounds):
this._renderImage(response.imageData,bounds,response.contentType))},this):(params.f="image",params=this.options.url+"export"+leaflet.Util.getParamString(params),this.options.proxy&&(params=this.options.proxy+"?"+params),this._renderImage(params,bounds))}}),FeatureGrid=leaflet.Layer.extend({options:{cellSize:512,updateWhenIdle:leaflet.Browser.mobile,updateInterval:150,noWrap:!1,keepBuffer:1.5},initialize:function(options){leaflet.Util.setOptions(this,options)},onAdd:function(map){this._cells={};this._activeCells=
{};this._resetView();this._update()},onRemove:function(map){this._removeAllCells();this._cellZoom=void 0},isLoading:function(){return this._loading},redraw:function(){this._map&&(this._removeAllCells(),this._update());return this},getEvents:function(){var events={viewprereset:this._invalidateAll,viewreset:this._resetView,zoom:this._resetView,moveend:this._onMoveEnd};this.options.updateWhenIdle||(this._onMove||(this._onMove=leaflet.Util.throttle(this._onMoveEnd,this.options.updateInterval,this)),events.move=
this._onMove);return events},createCell:function(){return document.createElement("div")},removeCell:function(){},reuseCell:function(){},cellLeave:function(){},cellEnter:function(){},getCellSize:function(){var s=this.options.cellSize;return s instanceof leaflet.Point?s:new leaflet.Point(s,s)},_pruneCells:function(){if(this._map){var key;for(key in this._cells){var cell=this._cells[key];cell.retain=cell.current}for(key in this._cells)cell=this._cells[key],cell.current&&!cell.active&&(cell=cell.coords,
this._retainParent(cell.x,cell.y,cell.z,cell.z-5)||this._retainChildren(cell.x,cell.y,cell.z,cell.z+2));for(key in this._cells)this._cells[key].retain||this._removeCell(key)}},_removeAllCells:function(){for(var key in this._cells)this._removeCell(key)},_invalidateAll:function(){this._removeAllCells();this._cellZoom=void 0},_retainParent:function(x,y,z,minZoom){x=Math.floor(x/2);y=Math.floor(y/2);--z;var coords2=new leaflet.Point(+x,+y);coords2.z=+z;coords2=this._cellCoordsToKey(coords2);if((coords2=
this._cells[coords2])&&coords2.active)return coords2.retain=!0;coords2&&coords2.loaded&&(coords2.retain=!0);return z>minZoom?this._retainParent(x,y,z,minZoom):!1},_retainChildren:function(x,y,z,maxZoom){for(var i=2*x;i<2*x+2;i++)for(var j=2*y;j<2*y+2;j++){var coords=new leaflet.Point(i,j);coords.z=z+1;coords=this._cellCoordsToKey(coords);(coords=this._cells[coords])&&coords.active?coords.retain=!0:(coords&&coords.loaded&&(coords.retain=!0),z+1<maxZoom&&this._retainChildren(i,j,z+1,maxZoom))}},_resetView:function(e){(e=
e&&(e.pinch||e.flyTo))||this._setView(this._map.getCenter(),this._map.getZoom(),e,e)},_setView:function(center,zoom,noPrune,noUpdate){zoom=Math.round(zoom);noUpdate||(this._cellZoom=zoom,this._abortLoading&&this._abortLoading(),this._resetGrid(),void 0!==zoom&&this._update(center),noPrune||this._pruneCells(),this._noPrune=!!noPrune)},_resetGrid:function(){var map=this._map,crs=map.options.crs,cellSize=this._cellSize=this.getCellSize(),cellZoom=this._cellZoom,bounds=this._map.getPixelWorldBounds(this._cellZoom);
bounds&&(this._globalCellRange=this._pxBoundsToCellRange(bounds));this._wrapX=crs.wrapLng&&!this.options.noWrap&&[Math.floor(map.project([0,crs.wrapLng[0]],cellZoom).x/cellSize.x),Math.ceil(map.project([0,crs.wrapLng[1]],cellZoom).x/cellSize.y)];this._wrapY=crs.wrapLat&&!this.options.noWrap&&[Math.floor(map.project([crs.wrapLat[0],0],cellZoom).y/cellSize.x),Math.ceil(map.project([crs.wrapLat[1],0],cellZoom).y/cellSize.y)]},_onMoveEnd:function(e){e&&(e.pinch||e.flyTo)||!this._map||this._map._animatingZoom||
this._update()},_getCelldPixelBounds:function(center){var map=this._map,mapZoom=map._animatingZoom?Math.max(map._animateToZoom,map.getZoom()):map.getZoom();mapZoom=map.getZoomScale(mapZoom,this._cellZoom);center=map.project(center,this._cellZoom).floor();map=map.getSize().divideBy(2*mapZoom);return new leaflet.Bounds(center.subtract(map),center.add(map))},_update:function(center){var map=this._map;if(map){var zoom=Math.round(map.getZoom());void 0===center&&(center=map.getCenter());map=this._getCelldPixelBounds(center);
var cellRange=this._pxBoundsToCellRange(map),cellCenter=cellRange.getCenter();map=[];var margin=this.options.keepBuffer;margin=new leaflet.Bounds(cellRange.getBottomLeft().subtract([margin,-margin]),cellRange.getTopRight().add([margin,-margin]));if(!(isFinite(cellRange.min.x)&&isFinite(cellRange.min.y)&&isFinite(cellRange.max.x)&&isFinite(cellRange.max.y)))throw Error("Attempted to load an infinite number of cells");for(var key in this._cells){var c=this._cells[key].coords;c.z===this._cellZoom&&margin.contains(new leaflet.Point(c.x,
c.y))||(this._cells[key].current=!1)}if(1<Math.abs(zoom-this._cellZoom))this._setView(center,zoom);else{for(zoom=cellRange.min.y;zoom<=cellRange.max.y;zoom++)for(center=cellRange.min.x;center<=cellRange.max.x;center++)key=new leaflet.Point(center,zoom),key.z=this._cellZoom,this._isValidCell(key)&&((margin=this._cells[this._cellCoordsToKey(key)])?margin.current=!0:map.push(key));map.sort(function(a,b){return a.distanceTo(cellCenter)-b.distanceTo(cellCenter)});if(0!==map.length)for(this._loading||(this._loading=
!0),center=0;center<map.length;center++)cellRange=this._cellCoordsToKey(map[center]),cellRange=this._keyToCellCoords(cellRange),this._activeCells[cellRange]?this._reuseCell(map[center]):this._createCell(map[center])}}},_isValidCell:function(coords){var crs=this._map.options.crs;if(!crs.infinite){var bounds=this._globalCellRange;if(!crs.wrapLng&&(coords.x<bounds.min.x||coords.x>bounds.max.x)||!crs.wrapLat&&(coords.y<bounds.min.y||coords.y>bounds.max.y))return!1}if(!this.options.bounds)return!0;coords=
this._cellCoordsToBounds(coords);return leaflet.toLatLngBounds(this.options.bounds).overlaps(coords)},_keyToBounds:function(key){return this._cellCoordsToBounds(this._keyToCellCoords(key))},_cellCoordsToNwSe:function(coords){var map=this._map,cellSize=this.getCellSize(),nwPoint=coords.scaleBy(cellSize);cellSize=nwPoint.add(cellSize);nwPoint=map.unproject(nwPoint,coords.z);coords=map.unproject(cellSize,coords.z);return[nwPoint,coords]},_cellCoordsToBounds:function(coords){coords=this._cellCoordsToNwSe(coords);
coords=new leaflet.LatLngBounds(coords[0],coords[1]);this.options.noWrap||(coords=this._map.wrapLatLngBounds(coords));return coords},_cellCoordsToKey:function(coords){return coords.x+":"+coords.y+":"+coords.z},_keyToCellCoords:function(key){key=key.split(":");var coords=new leaflet.Point(+key[0],+key[1]);coords.z=+key[2];return coords},_removeCell:function(key){var cell=this._cells[key];if(cell){var coords=this._keyToCellCoords(key),wrappedCoords=this._wrapCoords(coords);coords=this._cellCoordsToBounds(this._wrapCoords(coords));
cell.current=!1;delete this._cells[key];this._activeCells[key]=cell;this.cellLeave(coords,wrappedCoords,key);this.fire("cellleave",{key,coords:wrappedCoords,bounds:coords})}},_reuseCell:function(coords){var key=this._cellCoordsToKey(coords);this._cells[key]=this._activeCells[key];this._cells[key].current=!0;var wrappedCoords=this._wrapCoords(coords);coords=this._cellCoordsToBounds(this._wrapCoords(coords));this.cellEnter(coords,wrappedCoords,key);this.fire("cellenter",{key,coords:wrappedCoords,bounds:coords})},
_createCell:function(coords){var key=this._cellCoordsToKey(coords),wrappedCoords=this._wrapCoords(coords),cellBounds=this._cellCoordsToBounds(this._wrapCoords(coords));this.createCell(cellBounds,wrappedCoords,key);this.fire("cellcreate",{key,coords:wrappedCoords,bounds:cellBounds});this._cells[key]={coords,current:!0};leaflet.Util.requestAnimFrame(this._pruneCells,this)},_cellReady:function(coords,err,cell){coords=this._cellCoordsToKey(coords);if(cell=this._cells[coords])cell.loaded=+new Date,cell.active=
!0},_getCellPos:function(coords){return coords.scaleBy(this.getCellSize())},_wrapCoords:function(coords){var newCoords=new leaflet.Point(this._wrapX?leaflet.Util.wrapNum(coords.x,this._wrapX):coords.x,this._wrapY?leaflet.Util.wrapNum(coords.y,this._wrapY):coords.y);newCoords.z=coords.z;return newCoords},_pxBoundsToCellRange:function(bounds){var cellSize=this.getCellSize();return new leaflet.Bounds(bounds.min.unscaleBy(cellSize).floor(),bounds.max.unscaleBy(cellSize).ceil().subtract([1,1]))}});BinarySearchIndex.prototype.query=
function(value){value=this.getIndex(value);return this.values[value]};BinarySearchIndex.prototype.getIndex=function(value){this.dirty&&this.sort();for(var minIndex=0,maxIndex=this.values.length-1,currentIndex,currentElement;minIndex<=maxIndex;)if(currentIndex=(minIndex+maxIndex)/2|0,currentElement=this.values[Math.round(currentIndex)],+currentElement.value<+value)minIndex=currentIndex+1;else if(+currentElement.value>+value)maxIndex=currentIndex-1;else return currentIndex;return Math.abs(~maxIndex)};
BinarySearchIndex.prototype.between=function(start,end){var startIndex=this.getIndex(start),endIndex=this.getIndex(end);if(0===startIndex&&0===endIndex)return[];for(;this.values[startIndex-1]&&this.values[startIndex-1].value===start;)startIndex--;for(;this.values[endIndex+1]&&this.values[endIndex+1].value===end;)endIndex++;this.values[endIndex]&&this.values[endIndex].value===end&&this.values[endIndex+1]&&endIndex++;return this.values.slice(startIndex,endIndex)};BinarySearchIndex.prototype.insert=
function(item){this.values.splice(this.getIndex(item.value),0,item);return this};BinarySearchIndex.prototype.bulkAdd=function(items,sort){this.values=this.values.concat([].concat(items||[]));sort?this.sort():this.dirty=!0;return this};BinarySearchIndex.prototype.sort=function(){this.values.sort(function(a,b){return+b.value-+a.value}).reverse();this.dirty=!1;return this};var FeatureManager=FeatureGrid.extend({options:{attribution:null,where:"1\x3d1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",
simplifyFactor:0,precision:6,fetchAllFeatures:!1},initialize:function(options){FeatureGrid.prototype.initialize.call(this,options);options=getUrlParams(options);options=leaflet.Util.setOptions(this,options);this.service=featureLayerService(options);this.service.addEventParent(this);if("*"!==this.options.fields[0]){options=!1;for(var i=0;i<this.options.fields.length;i++)this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)&&(options=!0);!1===options&&warn("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}this.options.timeField.start&&
this.options.timeField.end?(this._startTimeIndex=new BinarySearchIndex,this._endTimeIndex=new BinarySearchIndex):this.options.timeField&&(this._timeIndex=new BinarySearchIndex);this._cache={};this._currentSnapshot=[];this._activeRequests=0},onAdd:function(map){setEsriAttribution(map);this.service.metadata(function(err,metadata){if(!err){err=metadata.supportedQueryFormats;var forceJsonFormat=!1;if(!1===this.service.options.isModern||this.options.fetchAllFeatures)forceJsonFormat=!0;!forceJsonFormat&&
err&&-1!==err.indexOf("geoJSON")&&(this.service.options.isModern=!0);metadata.objectIdField&&(this.service.options.idAttribute=metadata.objectIdField);!this.options.attribution&&map.attributionControl&&metadata.copyrightText&&(this.options.attribution=metadata.copyrightText,map.attributionControl.addAttribution(this.getAttribution()))}},this);map.on("zoomend",this._handleZoomChange,this);return FeatureGrid.prototype.onAdd.call(this,map)},onRemove:function(map){map.off("zoomend",this._handleZoomChange,
this);return FeatureGrid.prototype.onRemove.call(this,map)},getAttribution:function(){return this.options.attribution},createCell:function(bounds,coords){this._visibleZoom()&&this._requestFeatures(bounds,coords)},_requestFeatures:function(bounds,coords,callback,offset){this._activeRequests++;offset=offset||0;var originalWhere=this.options.where;1===this._activeRequests&&this.fire("loading",{bounds},!0);return this._buildQuery(bounds,offset).run(function(error,featureCollection,response){response&&
response.exceededTransferLimit&&this.fire("drawlimitexceeded");this.options.where===originalWhere&&(!error&&featureCollection&&featureCollection.features.length&&leaflet.Util.requestAnimFrame(leaflet.Util.bind(function(){this._addFeatures(featureCollection.features,coords);this._postProcessFeatures(bounds)},this)),error||!featureCollection||featureCollection.features.length||this._postProcessFeatures(bounds),error&&this._postProcessFeatures(bounds),callback&&callback.call(this,error,featureCollection),
response&&(response.exceededTransferLimit||response.properties&&response.properties.exceededTransferLimit)&&this.options.fetchAllFeatures&&this._requestFeatures(bounds,coords,callback,offset+featureCollection.features.length))},this)},_postProcessFeatures:function(bounds){this._activeRequests--;0>=this._activeRequests&&this.fire("load",{bounds})},_cacheKey:function(coords){return coords.z+":"+coords.x+":"+coords.y},_addFeatures:function(features,coords){if(coords){var key=this._cacheKey(coords);this._cache[key]=
this._cache[key]||[]}for(coords=features.length-1;0<=coords;coords--){var id=features[coords].id;-1===this._currentSnapshot.indexOf(id)&&this._currentSnapshot.push(id);"undefined"!==typeof key&&-1===this._cache[key].indexOf(id)&&this._cache[key].push(id)}this.options.timeField&&this._buildTimeIndexes(features);this.createLayers(features)},_buildQuery:function(bounds,offset){bounds=this.service.query().intersects(bounds).where(this.options.where).fields(this.options.fields).precision(this.options.precision);
this.options.fetchAllFeatures&&!isNaN(parseInt(offset))&&(bounds=bounds.offset(offset));bounds.params.resultType="tile";this.options.requestParams&&leaflet.Util.extend(bounds.params,this.options.requestParams);this.options.simplifyFactor&&bounds.simplify(this._map,this.options.simplifyFactor);"server"===this.options.timeFilterMode&&this.options.from&&this.options.to&&bounds.between(this.options.from,this.options.to);return bounds},setWhere:function(where,callback,context){this.options.where=where&&
where.length?where:"1\x3d1";for(var oldSnapshot=[],newSnapshot=[],pendingRequests=0,requestError=null,requestCallback=leaflet.Util.bind(function(error,featureCollection){error&&(requestError=error);if(featureCollection)for(error=featureCollection.features.length-1;0<=error;error--)newSnapshot.push(featureCollection.features[error].id);pendingRequests--;0>=pendingRequests&&this._visibleZoom()&&where===this.options.where&&(this._currentSnapshot=newSnapshot,leaflet.Util.requestAnimFrame(leaflet.Util.bind(function(){this.removeLayers(oldSnapshot);
this.addLayers(newSnapshot);callback&&callback.call(context,requestError)},this)))},this),i=this._currentSnapshot.length-1;0<=i;i--)oldSnapshot.push(this._currentSnapshot[i]);this._cache={};for(var key in this._cells){pendingRequests++;i=this._keyToCellCoords(key);var bounds=this._cellCoordsToBounds(i);this._requestFeatures(bounds,i,requestCallback)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(from,
to,callback,context){var oldFrom=this.options.from,oldTo=this.options.to,pendingRequests=0,requestError=null,requestCallback=leaflet.Util.bind(function(error){error&&(requestError=error);this._filterExistingFeatures(oldFrom,oldTo,from,to);pendingRequests--;callback&&0>=pendingRequests&&callback.call(context,requestError)},this);this.options.from=from;this.options.to=to;this._filterExistingFeatures(oldFrom,oldTo,from,to);if("server"===this.options.timeFilterMode)for(var key in this._cells){pendingRequests++;
var coords=this._keyToCellCoords(key),bounds=this._cellCoordsToBounds(coords);this._requestFeatures(bounds,coords,requestCallback)}return this},refresh:function(){this.setWhere(this.options.where)},_filterExistingFeatures:function(oldFrom,oldTo,newFrom,newTo){var layersToRemove=oldFrom&&oldTo?this._getFeaturesInTimeRange(oldFrom,oldTo):this._currentSnapshot,layersToAdd=this._getFeaturesInTimeRange(newFrom,newTo);if(layersToAdd.indexOf)for(oldFrom=0;oldFrom<layersToAdd.length;oldFrom++)oldTo=layersToRemove.indexOf(layersToAdd[oldFrom]),
0<=oldTo&&layersToRemove.splice(oldTo,1);leaflet.Util.requestAnimFrame(leaflet.Util.bind(function(){this.removeLayers(layersToRemove);this.addLayers(layersToAdd)},this))},_getFeaturesInTimeRange:function(start,end){var ids=[];if(this.options.timeField.start&&this.options.timeField.end){var search=this._startTimeIndex.between(start,end);start=this._endTimeIndex.between(start,end);search=search.concat(start)}else if(this._timeIndex)search=this._timeIndex.between(start,end);else return warn("You must set timeField in the layer constructor in order to manipulate the start and end time filter."),
[];for(start=search.length-1;0<=start;start--)ids.push(search[start].id);return ids},_buildTimeIndexes:function(geojson){var i;if(this.options.timeField.start&&this.options.timeField.end){var startTimeEntries=[],endTimeEntries=[];for(i=geojson.length-1;0<=i;i--){var feature=geojson[i];startTimeEntries.push({id:feature.id,value:new Date(feature.properties[this.options.timeField.start])});endTimeEntries.push({id:feature.id,value:new Date(feature.properties[this.options.timeField.end])})}this._startTimeIndex.bulkAdd(startTimeEntries);
this._endTimeIndex.bulkAdd(endTimeEntries)}else{startTimeEntries=[];for(i=geojson.length-1;0<=i;i--)feature=geojson[i],startTimeEntries.push({id:feature.id,value:new Date(feature.properties[this.options.timeField])});this._timeIndex.bulkAdd(startTimeEntries)}},_featureWithinTimeRange:function(feature){if(!this.options.from||!this.options.to)return!0;var from=+this.options.from.valueOf(),to=+this.options.to.valueOf();if("string"===typeof this.options.timeField){var date=+feature.properties[this.options.timeField];
return date>=from&&date<=to}if(this.options.timeField.start&&this.options.timeField.end)return date=+feature.properties[this.options.timeField.start],feature=+feature.properties[this.options.timeField.end],date>=from&&date<=to||feature>=from&&feature<=to||date<=from&&feature>=to},_visibleZoom:function(){if(!this._map)return!1;var zoom=this._map.getZoom();return zoom>this.options.maxZoom||zoom<this.options.minZoom?!1:!0},_handleZoomChange:function(){if(this._visibleZoom())for(var i in this._cells){var key=
this._cacheKey(this._cells[i].coords);this._cache[key]&&this.addLayers(this._cache[key])}else this.removeLayers(this._currentSnapshot)},authenticate:function(token){this.service.authenticate(token);return this},metadata:function(callback,context){this.service.metadata(callback,context);return this},query:function(){return this.service.query()},_getMetadata:function(callback){this._metadata?callback(void 0,this._metadata):this.metadata(leaflet.Util.bind(function(error,response){this._metadata=response;
callback(error,this._metadata)},this))},addFeature:function(feature,callback,context){this.addFeatures(feature,callback,context)},addFeatures:function(features,callback,context){this._getMetadata(leaflet.Util.bind(function(error$jscomp$0,metadata){if(error$jscomp$0)callback&&callback.call(this,error$jscomp$0,null);else{var featuresArray=features.features?features.features:[features];this.service.addFeatures(features,leaflet.Util.bind(function(error,response){if(!error){for(var i=featuresArray.length-
1;0<=i;i--)featuresArray[i].properties[metadata.objectIdField]=1<featuresArray.length?response[i].objectId:response.objectId,featuresArray[i].id=1<featuresArray.length?response[i].objectId:response.objectId;this._addFeatures(featuresArray)}callback&&callback.call(context,error,response)},this))}},this))},updateFeature:function(feature,callback,context){this.updateFeatures(feature,callback,context)},updateFeatures:function(features,callback,context){var featuresArray=features.features?features.features:
[features];this.service.updateFeatures(features,function(error,response){if(!error){for(var i=featuresArray.length-1;0<=i;i--)this.removeLayers([featuresArray[i].id],!0);this._addFeatures(featuresArray)}callback&&callback.call(context,error,response)},this)},deleteFeature:function(id,callback,context){this.deleteFeatures(id,callback,context)},deleteFeatures:function(ids,callback,context){return this.service.deleteFeatures(ids,function(error,response){var responseArray=response.length?response:[response];
if(!error&&0<responseArray.length)for(var i=responseArray.length-1;0<=i;i--)this.removeLayers([responseArray[i].objectId],!0);callback&&callback.call(context,error,response)},this)}}),FeatureLayer=FeatureManager.extend({options:{cacheLayers:!0},initialize:function(options){FeatureManager.prototype.initialize.call(this,options);this._originalStyle=this.options.style;this._layers={}},onRemove:function(map){for(var i in this._layers)map.removeLayer(this._layers[i]),this.fire("removefeature",{feature:this._layers[i].feature,
permanent:!1},!0);return FeatureManager.prototype.onRemove.call(this,map)},createNewLayer:function(geojson){if(geojson=leaflet.GeoJSON.geometryToLayer(geojson,this.options))geojson.defaultOptions=geojson.options;return geojson},_updateLayer:function(layer,geojson){var coordsToLatLng=this.options.coordsToLatLng||leaflet.GeoJSON.coordsToLatLng;geojson.properties&&(layer.feature.properties=geojson.properties);switch(geojson.geometry.type){case "Point":geojson=leaflet.GeoJSON.coordsToLatLng(geojson.geometry.coordinates);
layer.setLatLng(geojson);break;case "LineString":geojson=leaflet.GeoJSON.coordsToLatLngs(geojson.geometry.coordinates,0,coordsToLatLng);layer.setLatLngs(geojson);break;case "MultiLineString":geojson=leaflet.GeoJSON.coordsToLatLngs(geojson.geometry.coordinates,1,coordsToLatLng);layer.setLatLngs(geojson);break;case "Polygon":geojson=leaflet.GeoJSON.coordsToLatLngs(geojson.geometry.coordinates,1,coordsToLatLng);layer.setLatLngs(geojson);break;case "MultiPolygon":geojson=leaflet.GeoJSON.coordsToLatLngs(geojson.geometry.coordinates,
2,coordsToLatLng),layer.setLatLngs(geojson)}},createLayers:function(features){for(var i=features.length-1;0<=i;i--){var geojson=features[i],layer=this._layers[geojson.id];!this._visibleZoom()||!layer||this._map.hasLayer(layer)||this.options.timeField&&!this._featureWithinTimeRange(geojson)||(this._map.addLayer(layer),this.fire("addfeature",{feature:layer.feature},!0));layer&&0<this.options.simplifyFactor&&(layer.setLatLngs||layer.setLatLng)&&this._updateLayer(layer,geojson);if(!layer)if(layer=this.createNewLayer(geojson)){layer.feature=
geojson;layer.addEventParent(this);if(this.options.onEachFeature)this.options.onEachFeature(layer.feature,layer);this._layers[layer.feature.id]=layer;this.setFeatureStyle(layer.feature.id,this.options.style);this.fire("createfeature",{feature:layer.feature},!0);this._visibleZoom()&&(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(geojson))&&this._map.addLayer(layer)}else warn("invalid GeoJSON encountered")}},addLayers:function(ids){for(var i=ids.length-1;0<=i;i--){var layer=
this._layers[ids[i]];!layer||this.options.timeField&&!this._featureWithinTimeRange(layer.feature)||this._map.addLayer(layer)}},removeLayers:function(ids,permanent){for(var i=ids.length-1;0<=i;i--){var id=ids[i],layer=this._layers[id];layer&&(this.fire("removefeature",{feature:layer.feature,permanent},!0),this._map.removeLayer(layer));layer&&permanent&&delete this._layers[id]}},cellEnter:function(bounds,coords){this._visibleZoom()&&!this._zooming&&this._map&&leaflet.Util.requestAnimFrame(leaflet.Util.bind(function(){var cacheKey=
this._cacheKey(coords),cellKey=this._cellCoordsToKey(coords);cacheKey=this._cache[cacheKey];this._activeCells[cellKey]&&cacheKey&&this.addLayers(cacheKey)},this))},cellLeave:function(bounds,coords){this._zooming||leaflet.Util.requestAnimFrame(leaflet.Util.bind(function(){if(this._map){var cacheKey=this._cacheKey(coords),cellKey=this._cellCoordsToKey(coords),layers=this._cache[cacheKey],mapBounds=this._map.getBounds();if(!this._activeCells[cellKey]&&layers){for(var removable=!0,i=0;i<layers.length;i++){var layer=
this._layers[layers[i]];layer&&layer.getBounds&&mapBounds.intersects(layer.getBounds())&&(removable=!1)}removable&&this.removeLayers(layers,!this.options.cacheLayers);!this.options.cacheLayers&&removable&&(delete this._cache[cacheKey],delete this._cells[cellKey],delete this._activeCells[cellKey])}}},this))},resetStyle:function(){this.options.style=this._originalStyle;this.eachFeature(function(layer){this.resetFeatureStyle(layer.feature.id)},this);return this},setStyle:function(style){this.options.style=
style;this.eachFeature(function(layer){this.setFeatureStyle(layer.feature.id,style)},this);return this},resetFeatureStyle:function(id){var layer=this._layers[id],style=this._originalStyle||leaflet.Path.prototype.options;layer&&(leaflet.Util.extend(layer.options,layer.defaultOptions),this.setFeatureStyle(id,style));return this},setFeatureStyle:function(id,style){id=this._layers[id];"function"===typeof style&&(style=style(id.feature));id.setStyle&&id.setStyle(style);return this},eachActiveFeature:function(fn,
context){if(this._map){var activeBounds=this._map.getBounds(),i;for(i in this._layers)-1!==this._currentSnapshot.indexOf(this._layers[i].feature.id)&&("function"===typeof this._layers[i].getLatLng&&activeBounds.contains(this._layers[i].getLatLng())?fn.call(context,this._layers[i]):"function"===typeof this._layers[i].getBounds&&activeBounds.intersects(this._layers[i].getBounds())&&fn.call(context,this._layers[i]))}return this},eachFeature:function(fn,context){for(var i in this._layers)fn.call(context,
this._layers[i]);return this},getFeature:function(id){return this._layers[id]},bringToBack:function(){this.eachFeature(function(layer){layer.bringToBack&&layer.bringToBack()})},bringToFront:function(){this.eachFeature(function(layer){layer.bringToFront&&layer.bringToFront()})},redraw:function(id){id&&this._redraw(id);return this},_redraw:function(id){id=this._layers[id];var geojson=id.feature;if(id&&id.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){var updatedIcon=this.options.pointToLayer(geojson,
leaflet.latLng(geojson.geometry.coordinates[1],geojson.geometry.coordinates[0])).options.icon;id.setIcon(updatedIcon)}id&&id.setStyle&&this.options.pointToLayer&&(updatedIcon=this.options.pointToLayer(geojson,leaflet.latLng(geojson.geometry.coordinates[1],geojson.geometry.coordinates[0])).options,this.setFeatureStyle(geojson.id,updatedIcon));id&&id.setStyle&&this.options.style&&this.resetStyle(geojson.id)}});exports.BasemapLayer=BasemapLayer;exports.DynamicMapLayer=DynamicMapLayer;exports.FeatureLayer=
FeatureLayer;exports.FeatureLayerService=FeatureLayerService;exports.FeatureManager=FeatureManager;exports.Find=Find;exports.Identify=Identify;exports.IdentifyFeatures=IdentifyFeatures;exports.IdentifyImage=IdentifyImage;exports.ImageMapLayer=ImageMapLayer;exports.ImageService=ImageService;exports.MapService=MapService;exports.Query=Query;exports.RasterLayer=cors;exports.Service=Service;exports.Support=Support;exports.Task=Task;exports.TiledMapLayer=TiledMapLayer;exports.Util=EsriUtil;exports.VERSION=
"2.5.1";exports.basemapLayer=function(key,options){return new BasemapLayer(key,options)};exports.dynamicMapLayer=function(url,options){return new DynamicMapLayer(url,options)};exports.featureLayer=function(options){return new FeatureLayer(options)};exports.featureLayerService=featureLayerService;exports.find=find;exports.get=get;exports.identify=function(options){return new Identify(options)};exports.identifyFeatures=identifyFeatures;exports.identifyImage=identifyImage;exports.imageMapLayer=function(url,
options){return new ImageMapLayer(url,options)};exports.imageService=imageService;exports.mapService=mapService;exports.options=options$jscomp$0;exports.post=xmlHttpPost;exports.query=query;exports.request=request$jscomp$0;exports.service=function(options){options=getUrlParams(options);return new Service(options)};exports.task=function(options){options=getUrlParams(options);return new Task(options)};exports.tiledMapLayer=function(url,options){return new TiledMapLayer(url,options)};Object.defineProperty(exports,
"__esModule",{value:!0})})}
//# sourceMappingURL=module$node_modules$esri_leaflet$dist$esri_leaflet_debug.js.map
